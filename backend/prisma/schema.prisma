generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum QueueStatus {
  MENUNGGU
  IN_WH
  PROSES
  SELESAI
  BATAL
}

enum QueueCategory {
  RECEIVING
  DELIVERY
}

enum AdminRole {
  ADMIN
  WAREHOUSE
  CS
}

enum WarehouseGate {
  WH1
  WH2
  DG
}

enum StoreType {
  STORE_IN
  STORE_OUT
}

enum TruckType {
  CDD
  CDE
  FUSO
  WB
  FT20
  FT40
  OTHER
}

model QueueEntry {
  id              String        @id @default(uuid())
  customerId      String?
  customer        Customer?     @relation(fields: [customerId], references: [id], onDelete: Restrict)
  gateId          String?
  gate            Gate?         @relation(fields: [gateId], references: [id], onDelete: SetNull)
  category        QueueCategory
  driverName      String
  truckNumber     String
  containerNumber String?
  registerTime    DateTime      @default(now())
  inWhTime        DateTime?
  startTime       DateTime?
  finishTime      DateTime?
  status          QueueStatus   @default(MENUNGGU)
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  logs            QueueLog[]

  @@index([status, registerTime])
  @@index([truckNumber, registerTime])
  @@index([category, registerTime])
  @@index([customerId, registerTime])
  @@index([gateId])
}

model QueueLog {
  id           String       @id @default(uuid())
  queueEntryId String
  type         String       @map("action")
  fromStatus   QueueStatus? @map("oldStatus")
  toStatus     QueueStatus? @map("newStatus")
  userName     String
  actorUserId  String?
  createdAt    DateTime     @default(now())
  entry        QueueEntry   @relation(fields: [queueEntryId], references: [id], onDelete: Cascade)
  actorUser    AdminUser?   @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([queueEntryId, createdAt])
  @@index([actorUserId])
}

model Customer {
  id                String             @id @default(uuid())
  name              String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  entries           QueueEntry[]
  shipmentSchedules ShipmentSchedule[]

  @@index([name])
}

model AdminUser {
  id                String             @id @default(uuid())
  name              String
  position          String
  phone             String
  role              AdminRole
  username          String             @unique
  passwordHash      String
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  logs              QueueLog[]
  shipmentSchedules ShipmentSchedule[]

  @@index([role])
  @@index([username])
}

model Gate {
  id        String         @id @default(uuid())
  gateNo    String
  area      String
  warehouse WarehouseGate
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  entries   QueueEntry[]

  @@unique([gateNo, warehouse])
  @@map("gates")
}

model ShipmentSchedule {
  id              String                 @id @default(uuid())
  scheduleDate    DateTime               @db.Date
  storeType       StoreType
  customerId      String
  customer        Customer               @relation(fields: [customerId], references: [id], onDelete: Restrict)
  createdByUserId String?
  createdByUser   AdminUser?             @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  items           ShipmentScheduleItem[]

  @@index([scheduleDate, storeType])
  @@index([customerId, scheduleDate])
  @@index([createdByUserId])
}

model ShipmentScheduleItem {
  id             String           @id @default(uuid())
  scheduleId     String
  schedule       ShipmentSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  truckType      TruckType
  truckTypeOther String?
  qty            Int
  createdAt      DateTime         @default(now())

  @@index([scheduleId])
  @@index([truckType])
}
